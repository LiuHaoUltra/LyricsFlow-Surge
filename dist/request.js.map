{"version":3,"file":"request.js","sources":["./src/request.ts","./src/utils/env.ts","./src/utils/logger.ts"],"sourcesContent":["import { env } from './utils/env';\r\nimport { logger } from './utils/logger';\r\n\r\nconst META_KEY_PREFIX = 'spotify_meta_';\r\n\r\nasync function handleRequest() {\r\n    const url = env.request.url;\r\n    // 确保只处理歌词接口\r\n    if (url.includes('/color-lyrics/v2/track/')) {\r\n        try {\r\n            const parts = url.split('/');\r\n            const trackIndex = parts.indexOf('track');\r\n            let trackId = '';\r\n            // 提取 Track ID\r\n            if (trackIndex !== -1 && parts[trackIndex + 1]) {\r\n                trackId = parts[trackIndex + 1].split('?')[0];\r\n            }\r\n\r\n            if (trackId) {\r\n                await fetchAndCacheMetadata(trackId);\r\n            }\r\n        } catch (err) {\r\n            logger.error(`[Request] Error: ${err}`);\r\n        }\r\n    }\r\n    env.done({});\r\n}\r\n\r\nasync function fetchAndCacheMetadata(trackId: string) {\r\n    const headers = env.request.headers || {};\r\n    // 关键：复用当前请求的 Authorization 头\r\n    const authHeader = headers['Authorization'] || headers['authorization'];\r\n\r\n    if (!authHeader) {\r\n        logger.warn(`[Request] No Auth Header`);\r\n        return;\r\n    }\r\n\r\n    // 修正：直接请求 Spotify 官方 Web API (返回 JSON)\r\n    const metaUrl = `https://api.spotify.com/v1/tracks/${trackId}`;\r\n\r\n    try {\r\n        const response = await env.fetch({\r\n            url: metaUrl,\r\n            method: 'GET',\r\n            headers: {\r\n                'Authorization': authHeader,\r\n                'Accept': 'application/json'\r\n            }\r\n        });\r\n\r\n        if (response.status === 200 && response.body) {\r\n            const data = typeof response.body === 'string' ? JSON.parse(response.body) : response.body;\r\n\r\n            // 提取需要的元数据\r\n            const meta = {\r\n                trackName: data.name,\r\n                artist: data.artists ? data.artists.map((a: any) => a.name).join(', ') : 'Unknown',\r\n                album: data.album ? data.album.name : 'Unknown',\r\n                duration: data.duration_ms\r\n            };\r\n\r\n            // 写入持久化缓存\r\n            env.setStorage(`${META_KEY_PREFIX}${trackId}`, JSON.stringify(meta));\r\n            logger.info(`[Request] Cached metadata: ${meta.trackName}`);\r\n        } else {\r\n            logger.warn(`[Request] Metadata fetch failed: ${response.status}`);\r\n        }\r\n    } catch (err) {\r\n        logger.error(`[Request] Fetch Error: ${err}`);\r\n    }\r\n}\r\n\r\nhandleRequest().catch(err => {\r\n    env.done({});\r\n});","/**\r\n * Environment Adapter for Surge\r\n * Handles HTTP requests, persistence, and script completion.\r\n */\r\n\r\nexport interface HelperRequestOpts {\r\n    url: string;\r\n    method?: string; // GET, POST, etc.\r\n    headers?: Record<string, string>;\r\n    body?: string | Uint8Array;\r\n    timeout?: number;\r\n    binary?: boolean; // If true, response body is expected to be binary (Uint8Array/Buffer)\r\n}\r\n\r\nexport class Env {\r\n    private name: string;\r\n    private isSurge: boolean;\r\n\r\n    constructor(name: string) {\r\n        this.name = name;\r\n        this.isSurge = typeof $httpClient !== 'undefined';\r\n    }\r\n\r\n    get args(): string {\r\n        return typeof $argument !== 'undefined' ? $argument : '';\r\n    }\r\n\r\n    get request(): any {\r\n        return typeof $request !== 'undefined' ? $request : { url: '', headers: {} };\r\n    }\r\n\r\n    /**\r\n     * Sends an HTTP request.\r\n     */\r\n    async fetch(opts: HelperRequestOpts): Promise<any> {\r\n        // Normalize method\r\n        const method = (opts.method || 'GET').toUpperCase();\r\n\r\n        // Prepare options for Surge\r\n        const requestOptions: any = {\r\n            url: opts.url,\r\n            method: method,\r\n            headers: opts.headers || {},\r\n            body: opts.body,\r\n            timeout: opts.timeout ? opts.timeout / 1000 : undefined, // Surge timeout is in seconds? usually defaults. \r\n        };\r\n\r\n        if (this.isSurge) {\r\n            if (opts.binary) {\r\n                // In Surge, for binary response, usually no special flag in request opts \r\n                // but $httpClient callback receives 'data' which can be binary if headers say so?\r\n                // Actually, $httpClient usually returns string or object. \r\n                // For binary, we might need to check how Surge handles it. \r\n                // usually it's automatic or we rely on 'node-buffer' polyfill if bundled.\r\n                // But for response, Surge passes `data`.\r\n            }\r\n\r\n            return new Promise((resolve, reject) => {\r\n                $httpClient[method.toLowerCase()](requestOptions, (error: any, response: any, data: any) => {\r\n                    if (error) {\r\n                        reject(error);\r\n                    } else {\r\n                        resolve({\r\n                            status: response.status || 200,\r\n                            headers: response.headers,\r\n                            body: data, // string or object or whatever Surge returns\r\n                        });\r\n                    }\r\n                });\r\n            });\r\n        } else {\r\n            // Fallback for Node/Testing (using global fetch if available)\r\n            return Promise.resolve({ error: \"Not in Surge environment\" });\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Writes to persistent storage.\r\n     */\r\n    setStorage(key: string, value: string): void {\r\n        if (this.isSurge) {\r\n            $persistentStore.write(value, key);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Reads from persistent storage.\r\n     */\r\n    getStorage(key: string): string | null {\r\n        if (this.isSurge) {\r\n            return $persistentStore.read(key);\r\n        }\r\n        return null;\r\n    }\r\n\r\n    /**\r\n     * Sends a system notification.\r\n     */\r\n    msg(title: string, subtitle: string, body: string): void {\r\n        if (this.isSurge) {\r\n            $notification.post(title, subtitle, body);\r\n        } else {\r\n            console.log(`[MSG] ${title} - ${subtitle}: ${body}`);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Completes the script execution.\r\n     */\r\n    done(value: any = {}): void {\r\n        if (this.isSurge) {\r\n            $done(value);\r\n        }\r\n    }\r\n}\r\n\r\n// Global types for Surge (to avoid TS errors)\r\ndeclare const $httpClient: any;\r\ndeclare const $persistentStore: any;\r\ndeclare const $notification: any;\r\ndeclare const $done: any;\r\ndeclare const $argument: string;\r\ndeclare const $request: any;\r\n\r\nexport const env = new Env('LyricsFlow');\r\n","export enum LogLevel {\r\n    OFF = 0,\r\n    ERROR = 1,\r\n    WARN = 2,\r\n    INFO = 3,\r\n    DEBUG = 4,\r\n}\r\n\r\nexport class Logger {\r\n    private level: LogLevel;\r\n    private prefix: string;\r\n\r\n    constructor(level: string | LogLevel = LogLevel.INFO, prefix: string = '') {\r\n        this.level = typeof level === 'string' ? this.parseLevel(level) : level;\r\n        this.prefix = prefix;\r\n    }\r\n\r\n    public setLevel(level: LogLevel) {\r\n        this.level = level;\r\n    }\r\n\r\n    private parseLevel(level: string): LogLevel {\r\n        switch (level.toUpperCase()) {\r\n            case 'OFF': return LogLevel.OFF;\r\n            case 'ERROR': return LogLevel.ERROR;\r\n            case 'WARN': return LogLevel.WARN;\r\n            case 'INFO': return LogLevel.INFO;\r\n            case 'DEBUG': return LogLevel.DEBUG;\r\n            default: return LogLevel.INFO;\r\n        }\r\n    }\r\n\r\n    private format(level: string, message: string, ...args: any[]): string {\r\n        const timestamp = new Date().toISOString().split('T')[1].slice(0, -1);\r\n        return `[${timestamp}] [${level}] ${this.prefix}${message}`;\r\n    }\r\n\r\n    error(message: string, ...args: any[]): void {\r\n        if (this.level >= LogLevel.ERROR) {\r\n            console.log(this.format('ERROR', message), ...args);\r\n        }\r\n    }\r\n\r\n    warn(message: string, ...args: any[]): void {\r\n        if (this.level >= LogLevel.WARN) {\r\n            console.log(this.format('WARN', message), ...args);\r\n        }\r\n    }\r\n\r\n    info(message: string, ...args: any[]): void {\r\n        if (this.level >= LogLevel.INFO) {\r\n            console.log(this.format('INFO', message), ...args);\r\n        }\r\n    }\r\n\r\n    debug(message: string, ...args: any[]): void {\r\n        if (this.level >= LogLevel.DEBUG) {\r\n            console.log(this.format('DEBUG', message), ...args);\r\n        }\r\n    }\r\n}\r\n\r\nexport const logger = new Logger(); // Default instance\r\n"],"names":["url","parts","trackIndex","trackId","err","env","includes","split","indexOf","fetchAndCacheMetadata","logger","headers","authHeader","metaUrl","response","data","meta","method","status","body","trackName","JSON","parse","name","artist","artists","map","a","join","album","duration","duration_ms","stringify","handleRequest","catch","Env","isSurge","$httpClient","$argument","$request","opts","requestOptions","toUpperCase","timeout","undefined","binary","Promise","resolve","reject","toLowerCase","error","key","value","$persistentStore","write","read","title","subtitle","$notification","post","console","log","$done","LogLevel","Logger","level","prefix","parseLevel","message","args","timestamp","Date","toISOString","slice","format"],"mappings":"o7CAKe,I,MAAA,GAAf,a,IACUA,EAIQC,EACAC,EACFC,EASCC,E,qDAbTJ,AAFEA,CAAAA,EAAM,EAAAK,GAAA,YAAe,AAAf,EAEJC,QAAQ,CAAC,2BAAb,O,+CAGUJ,EAAaD,AADbA,CAAAA,EAAQD,EAAIO,KAAK,CAAC,MACCC,OAAO,CAAC,SAC7BL,EAAU,GAEK,KAAfD,GAAqBD,CAAK,CAACC,EAAa,EAAE,EAC1CC,CAAAA,EAAUF,CAAK,CAACC,EAAa,EAAE,CAACK,KAAK,CAAC,IAAI,CAAC,EAAE,AAAD,E,CAG5CJ,EAAS,MAAT,C,KACA,O,EAAMM,A,SASeN,CAAe,E,OAArC,uB,EAT6BA,G,QAA5B,S,2CAECC,EAAA,SACL,EAAAM,MAAA,MAAY,CAAE,oBAAuB,OAAJN,I,oBAGzC,EAAAC,GAAA,KAAQ,CAAC,CAAC,G,MACd,EAAC,EArBc,qB,UAuBA,I,MAAA,GAAf,WAAqCF,CAAe,E,IAC1CQ,EAEAC,EAQAC,EAGIC,EAUIC,EAGAC,EAaLZ,E,iDAnCT,GAAI,CAFEQ,CAAAA,EAAaD,AAFbA,CAAAA,EAAU,EAAAN,GAAA,gBAAmB,EAAI,CAAC,GAEb,aAAgB,EAAIM,EAAQ,aAAgB,AAAhB,EAInD,OADA,EAAAD,MAAA,KAAW,CAAE,4BACb,C,GAIEG,EAAW,qCAA4C,OAARV,G,iBAGhC,O,sBAAA,C,EAAM,EAAAE,GAAA,MAAS,CAAC,CAC7BL,IAAKa,EACLI,OAAQ,MACRN,QAAS,CACL,cAAiBC,EACjB,OAAU,kBACd,CACJ,G,eAEIE,AAAoB,MAApBA,AATEA,CAAAA,EAAW,UASJI,MAAM,EAAYJ,EAASK,IAAI,EAIlCH,EAAO,CACTI,UAAWL,AAJTA,CAAAA,EAAO,AAAyB,UAAzB,OAAOD,EAASK,IAAI,CAAgBE,KAAKC,KAAK,CAACR,EAASK,IAAI,EAAIL,EAASK,IAAI,AAAD,EAIrEI,IAAI,CACpBC,OAAQT,EAAKU,OAAO,CAAGV,EAAKU,OAAO,CAACC,GAAG,CAAC,SAACC,CAAC,E,OAAUA,EAAEJ,IAAI,A,GAAEK,IAAI,CAAC,MAAQ,UACzEC,MAAOd,EAAKc,KAAK,CAAGd,EAAKc,KAAK,CAACN,IAAI,CAAG,UACtCO,SAAUf,EAAKgB,WAAW,AAC9B,EAGA,EAAA1B,GAAA,WAAc,CAAE,GAAoB,OA5DxB,iBA4DgC,OAARF,GAAWkB,KAAKW,SAAS,CAAChB,IAC9D,EAAAN,MAAA,KAAW,CAAE,8BAA4C,OAAfM,EAAKI,SAAS,IAExD,EAAAV,MAAA,KAAW,CAAE,oCAAmD,OAAhBI,EAASI,MAAM,G,oBAE9Dd,EAAA,SACL,EAAAM,MAAA,MAAY,CAAE,0BAA6B,OAAJN,I,yBAE/C,EAAC,EA3Cc,qB,CA6Cf6B,A,mBApEe,uB,KAoECC,KAAK,CAAC,SAAA9B,CAAA,EAClB,EAAAC,GAAA,KAAQ,CAAC,CAAC,EACd,E,6dCiDO,IAAMA,EAAM,GA9GZ,gB,eAAM8B,EAIGZ,CAAY,G,8FAJfY,GACT,OAAQ,OAAR,QACA,OAAQ,UAAR,QAGI,IAAI,CAACZ,IAAI,CAAGA,EACZ,IAAI,CAACa,OAAO,CAAG,AAAuB,aAAvB,OAAOC,W,UANjBF,E,EAAA,C,CASL,W,IAAJ,WACI,MAAO,AAAqB,aAArB,OAAOG,UAA4BA,UAAY,EAC1D,C,GAEI,c,IAAJ,WACI,MAAO,AAAoB,aAApB,OAAOC,SAA2BA,SAAW,CAAEvC,IAAK,GAAIW,QAAS,CAAC,CAAE,CAC/E,C,GAKM,Y,MAAN,SAAY6B,CAAuB,E,mBAAnC,C,EAAA,W,IAEUvB,EAGAwB,E,+jCAQN,CAXMxB,EAAU,AAAAuB,CAAAA,EAAKvB,MAAM,EAAI,OAAOyB,WAAW,GAG3CD,EAAsB,CACxBzC,IAAKwC,EAAKxC,GAAG,CACbiB,OAAQA,EACRN,QAAS6B,EAAK7B,OAAO,EAAI,CAAC,EAC1BQ,KAAMqB,EAAKrB,IAAI,CACfwB,QAASH,EAAKG,OAAO,CAAGH,EAAKG,OAAO,CAAG,IAAOC,KAAAA,CAClD,EAEI,EAAKR,OAAO,GACRI,EAAKK,MAAM,CASR,C,EAAA,IAAIC,QAAQ,SAACC,CAAO,CAAEC,CAAM,EAC/BX,WAAW,CAACpB,EAAOgC,WAAW,GAAG,CAACR,EAAgB,SAACS,CAAK,CAAOpC,CAAQ,CAAOC,CAAI,EAC1EmC,EACAF,EAAOE,GAEPH,EAAQ,CACJ7B,OAAQJ,EAASI,MAAM,EAAI,IAC3BP,QAASG,EAASH,OAAO,CACzBQ,KAAMJ,CACV,EAER,EACJ,G,EAGO,C,EAAA+B,QAAQC,OAAO,CAAC,CAAEG,MAAO,0BAA2B,G,EAEnE,E,kLAKA,iB,MAAA,SAAWC,CAAW,CAAEC,CAAa,EAC7B,IAAI,CAAChB,OAAO,EACZiB,iBAAiBC,KAAK,CAACF,EAAOD,EAEtC,C,GAKA,iB,MAAA,SAAWA,CAAW,SAClB,AAAI,IAAI,CAACf,OAAO,CACLiB,iBAAiBE,IAAI,CAACJ,GAE1B,IACX,C,GAKA,U,MAAA,SAAIK,CAAa,CAAEC,CAAgB,CAAEtC,CAAY,EACzC,IAAI,CAACiB,OAAO,CACZsB,cAAcC,IAAI,CAACH,EAAOC,EAAUtC,GAEpCyC,QAAQC,GAAG,CAAE,SAAmB,OAAXL,EAAM,OAAkB,OAAbC,EAAS,MAAS,OAALtC,GAErD,C,GAKA,W,MAAA,W,IAAKiC,EAAA,uDAAa,CAAC,CACX,KAAI,CAAChB,OAAO,EACZ0B,MAAMV,EAEd,C,8BAnGSjB,C,KA8Gc,a,4nCC5Hf4B,EAAAA,GAAAA,CAAAA,EAAA,I,gGA8DL,IA9DKA,E,EA8DCrD,EAAS,GAtDf,gB,eAAMsD,I,IAIGC,EAAA,yDAA0CC,EAAA,uDAAiB,I,8FAJ9DF,GACT,OAAQ,QAAR,QACA,OAAQ,SAAR,QAGI,IAAI,CAACC,KAAK,CAAG,AAAiB,UAAjB,OAAOA,EAAqB,IAAI,CAACE,UAAU,CAACF,GAASA,EAClE,IAAI,CAACC,MAAM,CAAGA,C,UANTF,E,EAAA,C,CASF,e,MAAP,SAAgBC,CAAe,EAC3B,IAAI,CAACA,KAAK,CAAGA,CACjB,C,GAEQ,iB,MAAR,SAAmBA,CAAa,EAC5B,OAAQA,EAAMvB,WAAW,IACrB,IAAK,MAAO,OAAO,CACnB,KAAK,QAAS,OAAO,CACrB,KAAK,OAAQ,OAAO,CACpB,KAAK,OAEL,QAFa,OAAO,CACpB,KAAK,QAAS,OAAO,CAEzB,CACJ,C,GAEQ,a,MAAR,SAAeuB,CAAa,CAAEG,CAAe,EAAE,2BAAGC,EAAH,6BAAGA,CAAI,CAAP,iBAAc,CACzD,IAAMC,EAAY,IAAIC,OAAOC,WAAW,GAAGjE,KAAK,CAAC,IAAI,CAAC,EAAE,CAACkE,KAAK,CAAC,EAAG,IAClE,MAAQ,IAAkB,OAAfH,EAAU,OAAe,OAAVL,EAAM,MAAkB,OAAd,IAAI,CAACC,MAAM,EAAW,OAARE,EACtD,C,GAEA,Y,MAAA,SAAMA,CAAe,EAAE,QAEf,EAFe,mBAAGC,EAAH,6BAAGA,CAAI,CAAP,iBAAc,AAC7B,KAAI,CAACJ,KAAK,EAAI,GACd,GAAAL,OAAA,EAAQC,GAAG,CAAX,SAAY,IAAI,CAACa,MAAM,CAAC,QAASN,GAAkB,CAAnD,OAA2C,EAAGC,IAEtD,C,GAEA,W,MAAA,SAAKD,CAAe,EAAE,QAEd,EAFc,mBAAGC,EAAH,6BAAGA,CAAI,CAAP,iBAAc,AAC5B,KAAI,CAACJ,KAAK,EAAI,GACd,GAAAL,OAAA,EAAQC,GAAG,CAAX,SAAY,IAAI,CAACa,MAAM,CAAC,OAAQN,GAAkB,CAAlD,OAA0C,EAAGC,IAErD,C,GAEA,W,MAAA,SAAKD,CAAe,EAAE,QAEd,EAFc,mBAAGC,EAAH,6BAAGA,CAAI,CAAP,iBAAc,AAC5B,KAAI,CAACJ,KAAK,EAAI,GACd,GAAAL,OAAA,EAAQC,GAAG,CAAX,SAAY,IAAI,CAACa,MAAM,CAAC,OAAQN,GAAkB,CAAlD,OAA0C,EAAGC,IAErD,C,GAEA,Y,MAAA,SAAMD,CAAe,EAAE,QAEf,EAFe,mBAAGC,EAAH,6BAAGA,CAAI,CAAP,iBAAc,AAC7B,KAAI,CAACJ,KAAK,EAAI,GACd,GAAAL,OAAA,EAAQC,GAAG,CAAX,SAAY,IAAI,CAACa,MAAM,CAAC,QAASN,GAAkB,CAAnD,OAA2C,EAAGC,IAEtD,C,8BAnDSL,C"}